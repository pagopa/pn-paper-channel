AWSTemplateFormatVersion: '2010-09-09'
Description: Some storage with input and output

Parameters:
  ProjectName:
    Type: String
    Description: Nome dell'ambiente destinazione

  # Unused but required by CD pipeline
  MicroserviceNumber:
    Type: Number
    Description: An unique number that identify the microservice inside the ECS cluster.

  # Unused but required by CD pipeline
  TemplateBucketBaseUrl:
    Type: String
    Description: URL da cui caricare i frammenti di template di infrastruttura

  Version:
    Type: String
    Description: 'keep track of used projects commitIds'

  CdcKinesisSourceStreamArn:
    Type: String
    Description: 'Where to send CDC'

Resources:
  PnPaperChannelZoneCapS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-paper-zone-cap'
  PnPaperChannelS3CustomResource:
    Type: Custom::PnPaperChannelS3CustomResource
    Properties:
      ServiceToken: !GetAtt PnPaperChannelLoadCSVLambda.Arn
      the_bucket: !Ref PnPaperChannelZoneCapS3Bucket
  PnPaperChannelLoadCSVLambda:
    Type: "AWS::Lambda::Function"
    Properties:
      Description: "Lambda for creating paper-channel CSVs on S3"
      FunctionName: !Sub '${ProjectName}-PaperLoadDataLambda'
      Handler: index.handler
      Role: !GetAtt PnPaperChannelLoadCSVLambdaRole.Arn
      Timeout: 360
      Runtime: python3.9
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          def handler(event, context):
              # Init ...
              the_event = event['RequestType']
              print("The event is: ", str(the_event))
              response_data = {}
              # Retrieve parameters
              the_bucket = event['ResourceProperties']['the_bucket']
              try:
                  if the_event == 'Create':
                      print("Creating csv file")
                      capsList = [
                          ['26834', 'Abbadia Cerreto'],
                          ['23821', 'Abbadia Lariana'],
                          ['53021', 'Abbadia San Salvatore'],
                          ['09071', 'Abbasanta'],
                          ['65020', 'Abbateggio'],
                          ['20081', 'Abbiategrasso'],
                          ['51021', 'Abetone'],
                          ['201xx', 'Milano'],
                          ['001xx', 'Roma'],
                          ['23030', 'Villa di Tirano'],
                          ['24020', 'Villa d''Ogna'],
                          ['35040', 'Villa Estense'],
                          ['18010', 'Villa Faraldi'],
                          ['22079', 'Villa Guardia'],
                          ['38060', 'Villa Lagarina'],
                          ['03040', 'Villa Latina'],
                          ['81039', 'Villa Literno'],
                          ['42030', 'Villa Minozzo'],
                          ['46020', 'Villa Poma'],
                          ['38080', 'Villa Rendena'],
                          ['89018', 'Villa San Giovanni'],
                          ['01010', 'Villa San Giovanni in Tuscia'],
                          ['09010', 'Villa San Pietro'],
                          ['14020', 'Villa San Secondo'],
                          ['03030', 'Villa Santa Lucia'],
                          ['67020', 'Villa Santa Lucia degli Abruzzi'],
                          ['66047', 'Villa Santa Maria'],
                          ['67020', 'Villa Sant''Angelo'],
                          ['09080', 'Villa Sant''Antonio'],
                          ['33029', 'Villa Santina'],
                          ['03020', 'Villa Santo Stefano'],
                          ['09090', 'Villa Verde'],
                          ['33059', 'Villa Vicentina'],
                          ['39039', 'Villabassa'],
                          ['90039', 'Villabate'],
                          ['25030', 'Villachiara'],
                          ['09039', 'Villacidro'],
                          ['15020', 'Villadeati'],
                          ['45010', 'Villadose'],
                          ['28844', 'Villadossola'],
                          ['12020', 'Villafalletto'],
                          ['14018', 'Villafranca d''Asti'],
                          ['37069', 'Villafranca di Verona'],
                          ['54028', 'Villafranca in Lunigiana'],
                          ['35010', 'Villafranca Padovana'],
                          ['10068', 'Villafranca Piemonte'],
                          ['92020', 'Villafranca Sicula'],
                          ['98049', 'Villafranca Tirrena'],
                          ['90030', 'Villafrati'],
                          ['36021', 'Villaga'],
                          ['08049', 'Villagrande Strisaili'],
                          ['67030', 'Villalago'],
                          ['93010', 'Villalba'],
                          ['66020', 'Villalfonsina'],
                          ['15050', 'Villalvernia'],
                          ['66010', 'Villamagna'],
                          ['83050', 'Villamaina'],
                          ['09020', 'Villamar'],
                          ['45030', 'Villamarzana'],
                          ['09010', 'Villamassargia'],
                          ['15020', 'Villamiroglio'],
                          ['39040', 'Villandro'],
                          ['13877', 'Villanova Biellese'],
                          ['10070', 'Villanova Canavese'],
                          ['17038', 'Villanova d''Albenga'],
                          ['27030', 'Villanova d''Ardenghi'],
                          ['14019', 'Villanova d''Asti'],
                          ['83030', 'Villanova del Battista'],
                          ['45020', 'Villanova del Ghebbo'],
                          ['26818', 'Villanova del Sillaro'],
                          ['35010', 'Villanova di Camposampiero'],
                          ['45030', 'Villanova Marchesana'],
                          ['12089', 'Villanova Mondovì'],
                          ['15030', 'Villanova Monferrato'],
                          ['07019', 'Villanova Monteleone'],
                          ['12030', 'Villanova Solaro'],
                          ['29010', 'Villanova sull''Arda'],
                          ['09084', 'Villanova Truschedu'],
                          ['08030', 'Villanova Tulo'],
                          ['09020', 'Villanovaforru'],
                          ['09020', 'Villanovafranca'],
                          ['27019', 'Villanterio'],
                          ['25089', 'Villanuova sul Clisi'],
                          ['09010', 'Villaperuccio'],
                          ['87076', 'Villapiana'],
                          ['09040', 'Villaputzu'],
                          ['10040', 'Villar Dora'],
                          ['10050', 'Villar Focchiardo'],
                          ['10060', 'Villar Pellice'],
                          ['10069', 'Villar Perosa'],
                          ['12020', 'Villar San Costanzo'],
                          ['10090', 'Villarbasse'],
                          ['13030', 'Villarboit'],
                          ['10030', 'Villareggia'],
                          ['80010', 'Villaricca'],
                          ['15050', 'Villaromagnano'],
                          ['94010', 'Villarosa'],
                          ['09040', 'Villasalto'],
                          ['20852', 'Villasanta'],
                          ['09049', 'Villasimius'],
                          ['09034', 'Villasor'],
                          ['09010', 'Villaspeciosa'],
                          ['10029', 'Villastellone'],
                          ['13010', 'Villata'],
                          ['09080', 'Villaurbana'],
                          ['67050', 'Villavallelonga'],
                          ['36030', 'Villaverla'],
                          ['11018', 'Villeneuve'],
                          ['34070', 'Villesse'],
                          ['67030', 'Villetta Barrea'],
                          ['28856', 'Villette'],
                          ['46039', 'Villimpenta'],
                          ['24060', 'Villongo'],
                          ['31020', 'Villorba'],
                          ['24020', 'Vilminore di Scalve'],
                          ['20871', 'Vimercate'],
                          ['20090', 'Vimodrone'],
                          ['12010', 'Vinadio'],
                          ['86019', 'Vinchiaturo'],
                          ['14040', 'Vinchio'],
                          ['50059', 'Vinci'],
                          ['10048', 'Vinovo'],
                          ['28060', 'Vinzaglio'],
                          ['12070', 'Viola'],
                          ['25050', 'Vione'],
                          ['39049', 'Vipiteno'],
                          ['46030', 'Virgilio'],
                          ['10060', 'Virle Piemonte'],
                          ['25010', 'Visano'],
                          ['10030', 'Vische'],
                          ['80030', 'Visciano'],
                          ['33040', 'Visco'],
                          ['15010', 'Visone'],
                          ['62039', 'Visso'],
                          ['27010', 'Vistarino'],
                          ['10080', 'Vistrorio'],
                          ['91010', 'Vita'],
                          ['01100', 'Viterbo'],
                          ['03040', 'Viticuso'],
                          ['33090', 'Vito d''Asio'],
                          ['01030', 'Vitorchiano'],
                          ['97019', 'Vittoria'],
                          ['31029', 'Vittorio Veneto'],
                          ['67030', 'Vittorito'],
                          ['20010', 'Vittuone'],
                          ['82038', 'Vitulano'],
                          ['81041', 'Vitulazio'],
                          ['10070', 'Viù'],
                          ['33099', 'Vivaro'],
                          ['00020', 'Vivaro Romano'],
                          ['13886', 'Viverone'],
                          ['95049', 'Vizzini'],
                          ['21010', 'Vizzola Ticino'],
                          ['20070', 'Vizzolo Predabissi'],
                          ['35030', 'Vo'''],
                          ['25079', 'Vobarno'],
                          ['16010', 'Vobbia'],
                          ['13020', 'Vocca'],
                          ['32040', 'Vodo Cadore'],
                          ['27058', 'Voghera'],
                          ['44019', 'Voghiera'],
                          ['28805', 'Vogogna'],
                          ['38060', 'Volano'],
                          ['80040', 'Volla'],
                          ['26030', 'Volongo'],
                          ['31040', 'Volpago del Montello'],
                          ['27047', 'Volpara'],
                          ['15059', 'Volpedo'],
                          ['15050', 'Volpeglino'],
                          ['10088', 'Volpiano'],
                          ['46049', 'Volta Mantovana'],
                          ['15060', 'Voltaggio'],
                          ['32020', 'Voltago Agordino'],
                          ['56048', 'Volterra'],
                          ['26030', 'Voltido'],
                          ['71030', 'Volturara Appula'],
                          ['83050', 'Volturara Irpina'],
                          ['71030', 'Volturino'],
                          ['10040', 'Volvera'],
                          ['12020', 'Vottignasco'],
                          ['89867', 'Zaccanopoli'],
                          ['95019', 'Zafferana Etnea'],
                          ['88050', 'Zagarise'],
                          ['00039', 'Zagarolo'],
                          ['38010', 'Zambana'],
                          ['89868', 'Zambrone'],
                          ['24060', 'Zandobbio'],
                          ['36010', 'Zanè'],
                          ['24050', 'Zanica'],
                          ['71030', 'Zapponeta'],
                          ['27059', 'Zavattarello'],
                          ['27010', 'Zeccone'],
                          ['09070', 'Zeddiani'],
                          ['22020', 'Zelbio'],
                          ['26839', 'Zelo Buon Persico'],
                          ['20080', 'Zelo Surrigone'],
                          ['27030', 'Zeme'],
                          ['27049', 'Zenevredo'],
                          ['31050', 'Zenson di Piave'],
                          ['29020', 'Zerba'],
                          ['27017', 'Zerbo'],
                          ['27020', 'Zerbolò'],
                          ['09070', 'Zerfaliu'],
                          ['54029', 'Zeri'],
                          ['36050', 'Zermeghedo'],
                          ['31059', 'Zero Branco'],
                          ['37059', 'Zevio'],
                          ['38030', 'Ziano di Fiemme'],
                          ['29010', 'Ziano Piacentino'],
                          ['43010', 'Zibello'],
                          ['20080', 'Zibido San Giacomo'],
                          ['19020', 'Zignago'],
                          ['37040', 'Zimella'],
                          ['13887', 'Zimone'],
                          ['27030', 'Zinasco'],
                          ['16030', 'Zoagli'],
                          ['41059', 'Zocca'],
                          ['24019', 'Zogno'],
                          ['40069', 'Zola Predosa'],
                          ['32010', 'Zoldo Alto'],
                          ['73010', 'Zollino'],
                          ['25050', 'Zone'],
                          ['32010', 'Zoppè di Cadore'],
                          ['33080', 'Zoppola'],
                          ['36020', 'Zovencedo'],
                          ['13888', 'Zubiena'],
                          ['17039', 'Zuccarello'],
                          ['38079', 'Zuclo'],
                          ['36030', 'Zugliano'],
                          ['33020', 'Zuglio'],
                          ['13848', 'Zumaglia'],
                          ['87040', 'Zumpano'],
                          ['83030', 'Zungoli'],
                          ['89867', 'Zungri']
                          ]
                      i = 0
                      multiLine = "cap,city\n"
                      for item in capsList:
                        newLine = ','.join(map(str, item))
                        if i > 0:
                          multiLine = multiLine + '\n'
                        multiLine = multiLine + newLine
                        i += 1
                      s_3 = boto3.resource('s3')
                      s_3.Object(the_bucket, 'caps-1.csv').put(Body=multiLine)
                      zonesList = [
                          ['Zona 1', 'Albania', 'Albania'],
                          ['Zona 1', 'Andorra', 'Andorra'],
                          ['Zona 1', 'Austria', 'Austria'],
                          ['Zona 1', 'Azzorre', 'Azzorre'],
                          ['Zona 1', 'Belgio', 'Belgio'],
                          ['Zona 1', 'Bielorussia', 'Bielorussia'],
                          ['Zona 1', 'Bosnia-Erzegovina', 'Bosnia-Erzegovina'],
                          ['Zona 1', 'Bulgaria', 'Bulgaria'],
                          ['Zona 1', 'Cipro', 'Cipro'],
                          ['Zona 1', 'Croazia', 'Croazia'],
                          ['Zona 1', 'Danimarca', 'Danimarca'],
                          ['Zona 1', 'Estonia', 'Estonia'],
                          ['Zona 1', 'Faroe (Isole)', 'Faroe (Isole)'],
                          ['Zona 1', 'Finlandia', 'Finlandia'],
                          ['Zona 1', 'Francia', 'Francia'],
                          ['Zona 1', 'Germania', 'Germania'],
                          ['Zona 1', 'Gibilterra', 'Gibilterra'],
                          ['Zona 1', 'Gran Bretagna e Irlanda del Nord', 'Gran Bretagna e Irlanda del Nord'],
                          ['Zona 1', 'Grecia', 'Grecia'],
                          ['Zona 1', 'Guernsey', 'Guernsey'],
                          ['Zona 1', 'Irlanda', 'Irlanda'],
                          ['Zona 1', 'Islanda', 'Islanda'],
                          ['Zona 1', 'Jersey', 'Jersey'],
                          ['Zona 1', 'Lettonia', 'Lettonia'],
                          ['Zona 1', 'Liechtenstein', 'Liechtenstein'],
                          ['Zona 1', 'Lituania', 'Lituania'],
                          ['Zona 1', 'Lussemburgo', 'Lussemburgo'],
                          ['Zona 1', 'Macedonia del Nord', 'Macedonia del Nord'],
                          ['Zona 1', 'Malta', 'Malta'],
                          ['Zona 1', 'Man Isole - Gran Bretagna UE', 'Man Isole - Gran Bretagna UE'],
                          ['Zona 1', 'Moldavia', 'Moldavia'],
                          ['Zona 1', 'Monaco', 'Monaco'],
                          ['Zona 1', 'Montenegro', 'Montenegro'],
                          ['Zona 1', 'Norvegia', 'Norvegia'],
                          ['Zona 1', 'Olanda', 'Olanda'],
                          ['Zona 1', 'Polonia', 'Polonia'],
                          ['Zona 1', 'Portogallo', 'Portogallo'],
                          ['Zona 1', 'Repubblica Ceca', 'Repubblica Ceca'],
                          ['Zona 1', 'Repubblica San Marino*', 'Repubblica San Marino*'],
                          ['Zona 1', 'Romania', 'Romania'],
                          ['Zona 1', 'Russia', 'Russia'],
                          ['Zona 1', 'Serbia', 'Serbia'],
                          ['Zona 1', 'Slovacchia', 'Slovacchia'],
                          ['Zona 1', 'Slovenia', 'Slovenia'],
                          ['Zona 1', 'Spagna', 'Spagna'],
                          ['Zona 1', 'Svezia', 'Svezia'],
                          ['Zona 1', 'Svizzera', 'Svizzera'],
                          ['Zona 1', 'Turchia', 'Turchia'],
                          ['Zona 1', 'Ucraina', 'Ucraina'],
                          ['Zona 1', 'Ungheria', 'Ungheria'],
                          ['Zona 1', 'Vaticano*', 'Vaticano*'],
                          ['Zona 1', 'Algeria', 'Algeria'],
                          ['Zona 1', 'Egitto', 'Egitto'],
                          ['Zona 1', 'Giordania', 'Giordania'],
                          ['Zona 1', 'Israele', 'Israele'],
                          ['Zona 1', 'Libano', 'Libano'],
                          ['Zona 1', 'Libia', 'Libia'],
                          ['Zona 1', 'Marocco', 'Marocco'],
                          ['Zona 1', 'Tunisia', 'Tunisia'],
                          ['Zona 2', 'Angola', 'Angola'],
                          ['Zona 2', 'Ascension - Isole (Uk)', 'Ascension - Isole (Uk)'],
                          ['Zona 2', 'Benin', 'Benin'],
                          ['Zona 2', 'Botswana', 'Botswana'],
                          ['Zona 2', 'Burkina Faso', 'Burkina Faso'],
                          ['Zona 2', 'Burundi', 'Burundi'],
                          ['Zona 2', 'Camerun', 'Camerun'],
                          ['Zona 2', 'Capo Verde', 'Capo Verde'],
                          ['Zona 2', 'Ciad', 'Ciad'],
                          ['Zona 2', 'Comore', 'Comore'],
                          ['Zona 2', 'Congo (Rep. Popolare)', 'Congo (Rep. Popolare)'],
                          ['Zona 2', 'Costa D''Avorio', 'Costa D''Avorio'],
                          ['Zona 2', 'Eritrea', 'Eritrea'],
                          ['Zona 2', 'Etiopia', 'Etiopia'],
                          ['Zona 2', 'Gabon', 'Gabon'],
                          ['Zona 2', 'Gambia', 'Gambia'],
                          ['Zona 2', 'Ghana', 'Ghana'],
                          ['Zona 2', 'Gibuti', 'Gibuti'],
                          ['Zona 2', 'Guinea', 'Guinea'],
                          ['Zona 2', 'Guinea Bissau', 'Guinea Bissau'],
                          ['Zona 2', 'Giunea Equatoriale', 'Giunea Equatoriale'],
                          ['Zona 2', 'Kenya', 'Kenya'],
                          ['Zona 2', 'Lesotho', 'Lesotho'],
                          ['Zona 2', 'Liberia', 'Liberia'],
                          ['Zona 2', 'Madagascar', 'Madagascar'],
                          ['Zona 2', 'Malawi', 'Malawi'],
                          ['Zona 2', 'Mali', 'Mali'],
                          ['Zona 2', 'Mauritania', 'Mauritania'],
                          ['Zona 2', 'Mauritius', 'Mauritius'],
                          ['Zona 2', 'Mayotte', 'Mayotte'],
                          ['Zona 2', 'Mozambico', 'Mozambico'],
                          ['Zona 2', 'Namibia', 'Namibia'],
                          ['Zona 2', 'Niger', 'Niger'],
                          ['Zona 2', 'Nigeria', 'Nigeria'],
                          ['Zona 2', 'Repubblica Centrafricana', 'Repubblica Centrafricana'],
                          ['Zona 2', 'Repubblica Del Congo', 'Repubblica Del Congo'],
                          ['Zona 2', 'Reunion (Isole)', 'Reunion (Isole)'],
                          ['Zona 2', 'Ruanda', 'Ruanda'],
                          ['Zona 2', 'Sant''Elena (Isola Di)', 'Sant''Elena (Isola Di)'],
                          ['Zona 2', 'S. Tommaso E Principe', 'S. Tommaso E Principe'],
                          ['Zona 2', 'Senegal', 'Senegal'],
                          ['Zona 2', 'Seychelles', 'Seychelles'],
                          ['Zona 2', 'Sierra Leone', 'Sierra Leone'],
                          ['Zona 2', 'Sud Africa', 'Sud Africa'],
                          ['Zona 2', 'Sudan', 'Sudan'],
                          ['Zona 2', 'Sud Sudan', 'Sud Sudan'],
                          ['Zona 2', 'Swaziland', 'Swaziland'],
                          ['Zona 2', 'Tanzania', 'Tanzania'],
                          ['Zona 2', 'Territorio Britannico dell''Oceano Indiano', 'Territorio Britannico dell''Oceano Indiano'],
                          ['Zona 2', 'Togo', 'Togo'],
                          ['Zona 2', 'Tristan Da Cunha', 'Tristan Da Cunha'],
                          ['Zona 2', 'Uganda', 'Uganda'],
                          ['Zona 2', 'Zambia', 'Zambia'],
                          ['Zona 2', 'Zimbabwe', 'Zimbabwe'],
                          ['Zona 2', 'Anguilla', 'Anguilla'],
                          ['Zona 2', 'Antigua & Barbuda', 'Antigua & Barbuda'],
                          ['Zona 2', 'Argentina', 'Argentina'],
                          ['Zona 2', 'Aruba', 'Aruba'],
                          ['Zona 2', 'Bahamas', 'Bahamas'],
                          ['Zona 2', 'Barbados', 'Barbados'],
                          ['Zona 2', 'Belize', 'Belize'],
                          ['Zona 2', 'Bermuda', 'Bermuda'],
                          ['Zona 2', 'Bolivia', 'Bolivia'],
                          ['Zona 2', 'Bonaire - (Antille Olandesi)', 'Bonaire - (Antille Olandesi)'],
                          ['Zona 2', 'Brasile', 'Brasile'],
                          ['Zona 2', 'Canada', 'Canada'],
                          ['Zona 2', 'Cayman Islands', 'Cayman Islands'],
                          ['Zona 2', 'Cile', 'Cile'],
                          ['Zona 2', 'Colombia', 'Colombia'],
                          ['Zona 2', 'Costa Rica', 'Costa Rica'],
                          ['Zona 2', 'Cuba', 'Cuba'],
                          ['Zona 2', 'Curacao', 'Curacao'],
                          ['Zona 2', 'Dominica', 'Dominica'],
                          ['Zona 2', 'Ecuador', 'Ecuador'],
                          ['Zona 2', 'El Salvador', 'El Salvador'],
                          ['Zona 2', 'Falklands (Isole)', 'Falklands (Isole)'],
                          ['Zona 2', 'Giamaica', 'Giamaica'],
                          ['Zona 2', 'Grenada', 'Grenada'],
                          ['Zona 2', 'Groenlandia', 'Groenlandia'],
                          ['Zona 2', 'Guadalupa', 'Guadalupa'],
                          ['Zona 2', 'Guantanamo Bay', 'Guantanamo Bay'],
                          ['Zona 2', 'Guatemala', 'Guatemala'],
                          ['Zona 2', 'Guyana', 'Guyana'],
                          ['Zona 2', 'Guyana (Francese)', 'Guyana (Francese)'],
                          ['Zona 2', 'Haiti', 'Haiti'],
                          ['Zona 2', 'Honduras', 'Honduras'],
                          ['Zona 2', 'Martinica', 'Martinica'],
                          ['Zona 2', 'Messico', 'Messico'],
                          ['Zona 2', 'Montserrat', 'Montserrat'],
                          ['Zona 2', 'Nicaragua', 'Nicaragua'],
                          ['Zona 2', 'Panama', 'Panama'],
                          ['Zona 2', 'Paraguay', 'Paraguay'],
                          ['Zona 2', 'Peru', 'Peru'],
                          ['Zona 2', 'Porto Rico', 'Porto Rico'],
                          ['Zona 2', 'Repubblica Dominicana', 'Repubblica Dominicana'],
                          ['Zona 2', 'Saba - (Antille Olandesi)', 'Saba - (Antille Olandesi)'],
                          ['Zona 2', 'Saint Barthelemy - (St. Barth)', 'Saint Barthelemy - (St. Barth)'],
                          ['Zona 2', 'Saitn Eustatius - (Antille Olandesi)', 'Saitn Eustatius - (Antille Olandesi)'],
                          ['Zona 2', 'S. Cristoforo', 'S. Cristoforo'],
                          ['Zona 2', 'Saint Lucia', 'Saint Lucia'],
                          ['Zona 2', 'Saint Pierre & Miquelon', 'Saint Pierre & Miquelon'],
                          ['Zona 2', 'Saint Vincent (E Granadines)', 'Saint Vincent (E Granadines)'],
                          ['Zona 2', 'Samoa Britanniche', 'Samoa Britanniche'],
                          ['Zona 2', 'Sint Maarten', 'Sint Maarten'],
                          ['Zona 2', 'South Georgia and The South Sandwich Islands', 'South Georgia and The South Sandwich Islands'],
                          ['Zona 2', 'Stati Uniti', 'Stati Uniti'],
                          ['Zona 2', 'Suriname', 'Suriname'],
                          ['Zona 2', 'Trinidad & Tobago', 'Trinidad & Tobago'],
                          ['Zona 2', 'Turks And Caicos Is.', 'Turks And Caicos Is.'],
                          ['Zona 2', 'Uruguay', 'Uruguay'],
                          ['Zona 2', 'Venezuela', 'Venezuela'],
                          ['Zona 2', 'Vergini (Isole) - Br', 'Vergini (Isole) - Br'],
                          ['Zona 2', 'Vergini (Isole) Usa - (St. Tomas & St. Croix)', 'Vergini (Isole) Usa - (St. Tomas & St. Croix)'],
                          ['Zona 2', 'Afghanistan', 'Afghanistan'],
                          ['Zona 2', 'Arabia Saudita', 'Arabia Saudita'],
                          ['Zona 2', 'Armenia', 'Armenia'],
                          ['Zona 2', 'Azerbaidjan', 'Azerbaidjan'],
                          ['Zona 2', 'Bahrain', 'Bahrain'],
                          ['Zona 2', 'Bangladesh', 'Bangladesh'],
                          ['Zona 2', 'Bhutan', 'Bhutan'],
                          ['Zona 2', 'Brunei', 'Brunei'],
                          ['Zona 2', 'Cambogia', 'Cambogia'],
                          ['Zona 2', 'China', 'China'],
                          ['Zona 2', 'Corea Del Nord - Rep. Dem.', 'Corea Del Nord - Rep. Dem.'],
                          ['Zona 2', 'Corea del Sud', 'Corea del Sud'],
                          ['Zona 2', 'Emirati Arabi Uniti', 'Emirati Arabi Uniti'],
                          ['Zona 2', 'Filippine', 'Filippine'],
                          ['Zona 2', 'Georgia', 'Georgia'],
                          ['Zona 2', 'Giappone', 'Giappone'],
                          ['Zona 2', 'Hong Kong', 'Hong Kong'],
                          ['Zona 2', 'India', 'India'],
                          ['Zona 2', 'Indonesia', 'Indonesia'],
                          ['Zona 2', 'Iran', 'Iran'],
                          ['Zona 2', 'Iraq', 'Iraq'],
                          ['Zona 2', 'Kazakistan', 'Kazakistan'],
                          ['Zona 2', 'Kirghizistan', 'Kirghizistan'],
                          ['Zona 2', 'Kuwait', 'Kuwait'],
                          ['Zona 2', 'Laos', 'Laos'],
                          ['Zona 2', 'Macao', 'Macao'],
                          ['Zona 2', 'Maldive', 'Maldive'],
                          ['Zona 2', 'Malesia', 'Malesia'],
                          ['Zona 2', 'Mongolia', 'Mongolia'],
                          ['Zona 2', 'Myanmar Burnma (Birmania)', 'Myanmar Burnma (Birmania)'],
                          ['Zona 2', 'Nepal', 'Nepal'],
                          ['Zona 2', 'Oman', 'Oman'],
                          ['Zona 2', 'Pakistan', 'Pakistan'],
                          ['Zona 2', 'Qatar', 'Qatar'],
                          ['Zona 2', 'Singapore', 'Singapore'],
                          ['Zona 2', 'Sri Lanka', 'Sri Lanka'],
                          ['Zona 2', 'Tagikistan', 'Tagikistan'],
                          ['Zona 2', 'Taiwan', 'Taiwan'],
                          ['Zona 2', 'Thailandia', 'Thailandia'],
                          ['Zona 2', 'Timor Orientale (Est)', 'Timor Orientale (Est)'],
                          ['Zona 2', 'Turkmenistan', 'Turkmenistan'],
                          ['Zona 2', 'Uzbekistan', 'Uzbekistan'],
                          ['Zona 2', 'Vietnam', 'Vietnam'],
                          ['Zona 3', 'Australia', 'Australia'],
                          ['Zona 3', 'Cook (Isole)', 'Cook (Isole)'],
                          ['Zona 3', 'Fiji (Isole)', 'Fiji (Isole)'],
                          ['Zona 3', 'Guam', 'Guam'],
                          ['Zona 3', 'Kiribati', 'Kiribati'],
                          ['Zona 3', 'Marshall (Isole)', 'Marshall (Isole)'],
                          ['Zona 3', 'Micronesia (Isole Caroline)', 'Micronesia (Isole Caroline)'],
                          ['Zona 3', 'Nauru', 'Nauru'],
                          ['Zona 3', 'Niue', 'Niue'],
                          ['Zona 3', 'Norfolk Island', 'Norfolk Island'],
                          ['Zona 3', 'Nuova Caledonia', 'Nuova Caledonia'],
                          ['Zona 3', 'Nuova Zelanda', 'Nuova Zelanda'],
                          ['Zona 3', 'Palau', 'Palau'],
                          ['Zona 3', 'Papua Nuova Guinea', 'Papua Nuova Guinea'],
                          ['Zona 3', 'Pitcairn', 'Pitcairn'],
                          ['Zona 3', 'Polinesia (Francese)', 'Polinesia (Francese)'],
                          ['Zona 3', 'Saipan (Isole Marianne)', 'Saipan (Isole Marianne)'],
                          ['Zona 3', 'Salomone (Isole)', 'Salomone (Isole)'],
                          ['Zona 3', 'Samoa (Americane)', 'Samoa (Americane)'],
                          ['Zona 3', ' Scattered Islands', ' Scattered Islands'],
                          ['Zona 3', 'Terre Australi e Antartiche Francesi', 'Terre Australi e Antartiche Francesi'],
                          ['Zona 3', 'Tokelau', 'Tokelau'],
                          ['Zona 3', 'Tonga (Isole)', 'Tonga (Isole)'],
                          ['Zona 3', 'Tuvalu', 'Tuvalu'],
                          ['Zona 3', 'Vanuatu', 'Vanuatu'],
                          ['Zona 3', 'Wake', 'Wake'],
                          ['Zona 3', 'Wallis & Futuna (Isole)', 'Wallis & Futuna (Isole)'],
                      ]
                      i = 0
                      multiLine = "zone,countryIt,countryEn\n"
                      for item in zonesList:
                        newLine = ','.join(map(str, item))
                        if i > 0:
                          multiLine = multiLine + '\n'
                        multiLine = multiLine + newLine
                        i += 1
                      s_3.Object(the_bucket, 'zones-1.csv').put(Body=multiLine)
                  elif the_event == 'Delete':
                      print("Deleting S3 content...")
                      b_operator = boto3.resource('s3')
                      b_operator.Bucket(str(the_bucket)).objects.all().delete()
                  # Everything OK... send the signal back
                  print("Operation successful!")
                  cfnresponse.send(event,
                                   context,
                                   cfnresponse.SUCCESS,
                                   response_data)
              except Exception as e:
                  print("Operation failed...")
                  print(str(e))
                  response_data['Data'] = str(e)
                  cfnresponse.send(event,
                                   context,
                                   cfnresponse.FAILED,
                                   response_data)
  PnPaperChannelLoadCSVLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-PnPaperChannelLoadCSVLambdaRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: !Sub ${ProjectName}-PnPaperChannelLoadCSVLambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CanWriteLogs
                Effect: "Allow"
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: "*"
              - Sid: CanWriteS3
                Effect: "Allow"
                Action:
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:List*
                Resource:
                  - !Sub arn:aws:s3:::${PnPaperChannelZoneCapS3Bucket}/*
                  - !Sub arn:aws:s3:::${PnPaperChannelZoneCapS3Bucket}
  PaperDeliveryDriversBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      ObjectLockEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedOrigins:
              - "*"
            ExposedHeaders:
              - "x-amz-version-id"

  PCKmsEncDecDynamoDataKey:
    Type: 'AWS::KMS::Key'
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Description: A symmetric encryption KMS key AES-256-GCM
      KeySpec: SYMMETRIC_DEFAULT
      KeyUsage: ENCRYPT_DECRYPT
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'

  # Application use this alias to access the public key
  PCKmsEncDecDynamoDataKeyAlias:
    Type: 'AWS::KMS::Alias'
    Properties:
      AliasName: !Sub 'alias/${ProjectName}-paper-channel-dynamo'
      TargetKeyId: !Ref PCKmsEncDecDynamoDataKey

  # Internal queues
  ScheduledRequestsQueue:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${TemplateBucketBaseUrl}/fragments/sqs-queue.yaml"
      Parameters:
        QueueName: !Sub '${ProjectName}-paper_channel_requests'
        DelaySeconds: 1

  RequestDeliveryDynamoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-PaperRequestDelivery'
      AttributeDefinitions:
        - AttributeName: "requestId"
          AttributeType: "S"
        - AttributeName: "fiscalCode"
          AttributeType: "S"
        - AttributeName: "correlationId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "requestId"
          KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      GlobalSecondaryIndexes:
        - IndexName: "fiscal-code-index"
          KeySchema:
            - AttributeName: "fiscalCode"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
        - IndexName: "correlation-index"
          KeySchema:
            - AttributeName: "correlationId"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE
  AddressDynamoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-PaperAddress'
      AttributeDefinitions:
        - AttributeName: "requestId"
          AttributeType: "S"
      TimeToLiveSpecification:
        AttributeName: "ttl"
        Enabled: true
      KeySchema:
        - AttributeName: "requestId"
          KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE

  TenderDynamoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-PaperTender'
      AttributeDefinitions:
        - AttributeName: "tenderCode"
          AttributeType: "S"
        - AttributeName: "author"
          AttributeType: "S"
        - AttributeName: "startDate"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "tenderCode"
          KeyType: "HASH"
      GlobalSecondaryIndexes:
        - IndexName: "author-index"
          KeySchema:
            - AttributeName: "author"
              KeyType: "HASH"
            - AttributeName: "startDate"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE

  DeliveryDriverDynamoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-PaperDeliveryDriver'
      AttributeDefinitions:
        - AttributeName: "uniqueCode"
          AttributeType: "S"
        - AttributeName: "tenderCode"
          AttributeType: "S"
        - AttributeName: "author"
          AttributeType: "S"
        - AttributeName: "startDate"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "uniqueCode"
          KeyType: "HASH"
        - AttributeName: "tenderCode"
          KeyType: "RANGE"
      GlobalSecondaryIndexes:
        - IndexName: "author-index"
          KeySchema:
            - AttributeName: "author"
              KeyType: "HASH"
            - AttributeName: "startDate"
              KeyType: "RANGE"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE

  CostDynamoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-PaperCost'
      AttributeDefinitions:
        - AttributeName: "idDeliveryDriver"
          AttributeType: "S"
        - AttributeName: "uuid"
          AttributeType: "S"
        - AttributeName: "cap"
          AttributeType: "S"
        - AttributeName: "zone"
          AttributeType: "S"
        - AttributeName: "tenderCode"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "idDeliveryDriver"
          KeyType: "HASH"
        - AttributeName: "uuid"
          KeyType: "RANGE"
      GlobalSecondaryIndexes:
        - IndexName: "cap-index"
          KeySchema:
            - AttributeName: "cap"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
        - IndexName: "zone-index"
          KeySchema:
            - AttributeName: "zone"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
        - IndexName: "tender-index"
          KeySchema:
            - AttributeName: "tenderCode"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE

  ZoneDynamoTable:
    Type: AWS::DynamoDB::Table
    DependsOn: PnPaperChannelS3CustomResource
    Properties:
      TableName: !Sub '${ProjectName}-PaperZone'
      AttributeDefinitions:
        - AttributeName: "countryIt"
          AttributeType: "S"
        - AttributeName: "countryEn"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "countryIt"
          KeyType: "HASH"
      GlobalSecondaryIndexes:
        - IndexName: "countryEn-index"
          KeySchema:
            - AttributeName: "countryEn"
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: "5"
            WriteCapacityUnits: "5"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      ImportSourceSpecification:
        InputFormat: 'CSV'
        InputFormatOptions:
          Csv:
            Delimiter: ','
        S3BucketSource:
          S3Bucket: !Ref PnPaperChannelZoneCapS3Bucket
          S3KeyPrefix: 'zones'
  CapDynamoTable:
    Type: AWS::DynamoDB::Table
    DependsOn: PnPaperChannelS3CustomResource
    Properties:
      TableName: !Sub '${ProjectName}-PaperCap'
      AttributeDefinitions:
        - AttributeName: "cap"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "cap"
          KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      ImportSourceSpecification:
        InputFormat: 'CSV'
        InputFormatOptions:
          Csv:
            Delimiter: ','
        S3BucketSource:
          S3Bucket: !Ref PnPaperChannelZoneCapS3Bucket
          S3KeyPrefix: 'caps'
  DeliveryFileDynamoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-PaperDeliveryFile'
      AttributeDefinitions:
        - AttributeName: "uuid"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "uuid"
          KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE

  PaperRequestErrorDynamoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-PaperRequestError'
      AttributeDefinitions:
        - AttributeName: "requestId"
          AttributeType: "S"
        - AttributeName: "created"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "requestId"
          KeyType: "HASH"
        - AttributeName: "created"
          KeyType: "RANGE"
      ProvisionedThroughput:
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      KinesisStreamSpecification:
        StreamArn: !Ref CdcKinesisSourceStreamArn
      StreamSpecification:
        StreamViewType: NEW_IMAGE

Outputs:
  PaperDeliveryDriversBucketName:
    Description: Name of s3 bucket
    Value: !Ref PaperDeliveryDriversBucket

  # Scheduled Requests
  ScheduledRequestsQueueName:
    Value: !GetAtt ScheduledRequestsQueue.Outputs.QueueName
    Description: pn-paper-channel input queue name
  ScheduledRequestsQueueURL:
    Value: !GetAtt ScheduledRequestsQueue.Outputs.QueueURL
    Description: pn-paper-channel input queue URL
  ScheduledRequestsQueueARN:
    Value: !GetAtt ScheduledRequestsQueue.Outputs.QueueARN
    Description: pn-paper-channel input queue ARN

  PCKmsEncDecDynamoDataKeyARN:
    Description: Name of KMS Key for Dynamo encode/decode data
    Value: !Sub '${PCKmsEncDecDynamoDataKey.Arn}'

  RequestDeliveryDynamoTableName:
    Description: Name of dynamodb table containing request
    Value: !Ref RequestDeliveryDynamoTable

  RequestDeliveryDynamoTableArn:
    Description: ARN of dynamodb table containing request
    Value: !Sub '${RequestDeliveryDynamoTable.Arn}'

  PaperRequestErrorTableName:
    Description: Name of dynamodb table containing request error
    Value: !Ref PaperRequestErrorDynamoTable

  PaperRequestErrorTableArn:
    Description: ARN of dynamodb table containing request error
    Value: !Sub '${PaperRequestErrorDynamoTable.Arn}'

  DeliveryFileDynamoTableName:
    Description: Name of dynamodb table containing file request
    Value: !Ref DeliveryFileDynamoTable

  DeliveryFileDynamoTableArn:
    Description: ARN of dynamodb table containing file request
    Value: !Sub '${DeliveryFileDynamoTable.Arn}'

  AddressDynamoTableName:
    Description: Name of dynamodb table containing address of request delivery
    Value: !Ref AddressDynamoTable

  AddressDynamoTableArn:
    Description: ARN of dynamodb table containing address of request delivery
    Value: !Sub '${AddressDynamoTable.Arn}'

  TenderDynamoTableName:
    Description: Name of dynamodb table containing tenders
    Value: !Ref TenderDynamoTable

  TenderDynamoTableArn:
    Description: ARN of dynamodb table containing tenders
    Value: !Sub '${TenderDynamoTable.Arn}'

  DeliveryDriverDynamoTableName:
    Description: Name of dynamodb table containing delivery drivers
    Value: !Ref DeliveryDriverDynamoTable

  DeliveryDriverDynamoTableArn:
    Description: ARN of dynamodb table containing delivery drivers
    Value: !Sub '${DeliveryDriverDynamoTable.Arn}'

  CostDynamoTableName:
    Description: Name of dynamodb table containing cost
    Value: !Ref CostDynamoTable

  CostDynamoTableArn:
    Description: ARN of dynamodb table containing cost
    Value: !Sub '${CostDynamoTable.Arn}'

  ZoneDynamoTableName:
    Description: Name of dynamodb table containing zone
    Value: !Ref ZoneDynamoTable

  ZoneDynamoTableArn:
    Description: ARN of dynamodb table containing zone
    Value: !Sub '${ZoneDynamoTable.Arn}'

  CapDynamoTableName:
    Description: Name of dynamodb table containing cap
    Value: !Ref CapDynamoTable

  CapDynamoTableArn:
    Description: ARN of dynamodb table containing cap
    Value: !Sub '${CapDynamoTable.Arn}'
