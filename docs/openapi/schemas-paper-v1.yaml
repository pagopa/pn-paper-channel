components:
  schemas:

    ##########################################################################
    ###                    RICHIESTA DI POSTALIZZAZIONE                    ###
    ##########################################################################

    ### - RICHIESTA
    ##################

    SendResponse:
      type: object
      required:
        - amount
      properties:
        amount:
          description: ammontare in eurocent del costo per l'invio della notifica in forma cartacea
          type: number

    PaperRequest:
      type: object
      properties:
        requestId:
          type: string
          example: 'ABCD-HILM-YKWX-202202-1_rec0_try1'
          description: >-
            Identificativo della richiesta. E' lo stesso usato nel path del metodo
        receiverFiscalCode:
          type: string
          description: >-
            Serve per poter recuperare da ANPR l'eventuale indirizzo fornito dall'utente alla banca dati nazionale.
            Potrebbe inoltre servire ai recapitisti in caso di offerte migliorative per i destinatari (servizi a valore aggiunto basati su cf).
        receiverType:
          type: string
          description: >-
            PF o PG in base al tipo di destinatario
        receiverAddress:
          $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Estremi del destinatario. Se presente, va usato.
        productType:
          description: >-
            Tipo prodotto di cui viene chiesto il recapito: <br/>
            - __AR__: Raccomandata Andata e Ritorno, <br/>
            - __890__: Recapito a norma della legge 890/1982, <br/>
            - __RI__: Raccomandata Internazionale, <br/>
            - __RS__: Raccomandata Semplice (per Avviso di mancato Recapito). <br/>
            - ... ulteriori prodotti
          type: string
          example: 'AR'
        printType:
          type: string
          description: >-
            Indica il tipo di stampa richiesto al Consolidatore <br />
            - __BN_FRONTE__: bianco e nero solo fronte <br/>
            - __BN_FRONTE_RETRO__: bianco e nero fronte e retro <br/>
            - ... ulteriori modalità previste dal contratto
            Se non presente prevedere il default
          example: 'BN_FRONTE_RETRO'
        attachmentUrls:
          type: array
          items:
            type: string
            description: >-
              Path in cui si trova il documento da allegare alla comunicazione digitale
              (i.e. url del file dentro Safe Storage che si occuperà di crypt/decrypt dei documenti).
              Il Safe Storge si occuperà di calcolare la presigned url per il recupero dell'allegato che sarà decifrato.
              documentUrl può rispondere (alla GET) con un 403 per redirect vs servizio (i.e. lambda, safe storage, presigned url vs bucket s3 non cifrato).
              Utilizzato per recuperare il conteggio delle pagine da stampare

    PrepareRequest:
      allOf:
        - $ref: '#/components/schemas/PaperRequest'
      type: object
      properties:
        alreadyUsedReceiverAddress:
          $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Indirizzo già usato in precedenza per l'utente.
            Se valorizzato indica che è una richiesta che fa seguito ad un tentativo precedente di invio non andato a buon fine.
            Va pertanto richiesto a pn-national-registry l'eventuale indirizzo presente nei registri pubblici, e se diverso da quello
            usato nel precedente tentativo, ha precedenza sull'eventuale discoveredAddress.
        discoveredAddress:
          $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Eventuali estremi del destinatario recuperati a valle dell'indagine del postino a fronte di un tentativo precedente non andato a buon fine.
            Se presente, va usato come indirizzo nel caso in cui la richiesta a pn-national-registry non fornisca un indirizzo valido, o se tale
            indirizzo è lo stesso usato in precedenza.

    SendRequest:
      allOf:
          - $ref: '#/components/schemas/PaperRequest'
      required:
        - requestId
        - requestPaId
        - clientRequestTimeStamp
        - productType
        - attachmentUrls
        - printType
        - senderAddress
        - receiverAddress
      type: object
      properties:
        requestPaId:
          type: string
          example: '00414580183'
          description: >-
            Identificativo della PA che ha richiesto il recapito. Utile per autorizzare il
            recupero, da parte delle pubbliche amministrazioni, degli originali cartacei
        clientRequestTimeStamp:
          type: string
          format: date-time
          description: >-
            Timestamp della richiesta in UTC
        senderAddress:
          $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Estremi della PA mittente
        arAddress:
          $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Estremi della PA mittente per l'avviso di ritorno
    ##########################################################################
    ###      NOTIFICHE DI AVANZAMENTO DEL PROCESSO DI POSTALIZZAZIONE      ###
    ##########################################################################

    ### - EVENTO SINGOLO
    #####################

    PaperEvent:
      required:
        - requestId
        - statusCode
        - statusDetail
        - statusDateTime
      type: object
      properties:
        requestId:
          type: string
          description: >-
            Identificativo della richiesta.
          example: 'ABCD-HILM-YKWX-202202-1_rec0_try1'
        statusCode:
          type: string
          description: codice dell'evento.
        statusDetail:
          type: string
          description: dettaglio associato all'evento.
        statusDateTime:
          type: string
          format: date-time
          description: >-
              Data stato con timezone

    PrepareEvent:
      allOf:
        - $ref: '#/components/schemas/PaperEvent'
      type: object
      properties:
        statusCode:
          type: string
          description: >-
            Codici di stato:
            - PROGRESS :  stato iniziale che indica che la richiesta è in fase di elaborazione
            - OK : nel caso di indirizzo valido e allegati recuperati correttamente. Prevede la presenza del receiverAddress
            - KOUNREACHABLE : nel caso in cui non sia disponibile un indirizzo per l'utente in base alle informazioni passate.
        receiverAddress:
          $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Indirizzo da usare per l'invio nell'operazione di send, obbligatorio nel caso di statusCode OK.

    SendEvent:
      allOf:
        - $ref: '#/components/schemas/PaperEvent'
      type: object
      properties:
        registeredLetterCode:
          type: string
          description: >-
            Il codice di tracciatura obbligatorio per i prodotti di corrispondenza tracciata.
          example: '123456789abc'
        statusCode:
          type: string
          description: >-
            Vengono ribattuti gli esiti di ext-channel, più eventuali eventi interni a paper-channel (codici PCXXX)
            _Codifica sintetica dello stato dell'esito._  <br/>
            - __001__ Stampato  <br/>
            - __002__ Disponibile al recapitista  <br/>
            - __003__ Preso in carico dal recapitista  <br/>
            - __004__ Consegnata  <br/>
            - __005__ Mancata consegna  <br/>
            - __006__ Furto/Smarrimanto/deterioramento  <br/>
            - __007__ Consegnato Ufficio Postale  <br/>
            - __008__ Mancata consegna Ufficio Postale  <br/>
            - __009__ Compiuta giacenza  <br/>

            - __PC001__ Paper channel nuova richiesta invio cartaceo, a valle di un fallimento "temporaneo"  <br/>

        statusDescription: 
          type: string
          example: 'Stampato'
          description: >-
            Descrizione dello stato del delivery cartaceo che viene notificato.
        statusDateTime:
          type: string
          format: date-time
          description: >-
            Data stato con timezone
        deliveryFailureCause: 
          description: >-
            _Motivazione di mancata consegna_ obbligtorie negli stati di mancata consegna  <br/>
            - __01__ destinatario irreperibile <br/>
            - __02__ destinatario deceduto <br/>
            - __03__ destinatario sconosciuto <br/>
            - __04__ destinatario trasferito <br/>
            - __05__ invio rifiutato <br/>
            - __06__ indirizzo inesatto <br/>
            - __07__ indirizzo inesistente <br/>
            - __08__ indirizzo insufficiente <br/>
            - ... Motivazioni aggiuntive concordate con il consolidatore
          type: string
        attachments: 
          description: >-
            elenco dei documenti prodotti che attestano quanto accaduto durante il processo 
            di postalizzazione
          type: array
          items:
            $ref: '#/components/schemas/AttachmentDetails'
        discoveredAddress:
            $ref: '#/components/schemas/AnalogAddress'
        clientRequestTimeStamp:
          type: string
          format: date-time
          description: >-
            Timestamp della richiesta in UTC
    
    AttachmentDetails:
      title: dettagli allegato a un evento del processo postale
      type: object
      required: 
        - id
        - documentType
        - url
        - date
      properties:
        id: 
          type: string
          description: >-
            Identificativo di riga.
        documentType:
          type: string
          description: >-
            La descrizione della tipologia di oggetto.
        url:
          type: string
          description: >-
            Le coordinate del documento correlato allo stato. 
        date:
          type: string
          format: date-time
          description: >-
            Data di produzione del documento.

    AnalogAddress:
      description: >-
        Indirizzo analogico
      required:
        - name
        - address
        - city
      properties:
        name:
          type: string
          description: >-
            Cognome e nome o ragione sociale del destinatario
        nameRow2:
          type: string
          description: >-
            Seconda riga sulla busta.
        address:
          type: string
          description: >-
            Indirizzo del destinatario.
        addressRow2:
          type: string
          description: >-
            Specifica dell’indirizzo di residenza del destinatario (seconda riga indirizzo sulla busta).
        cap:
          type: string
          description: >-
            Cap del destinatario; in caso di invio estero diventa facoltativo.
        city:
          type: string
          description: >-
            Comune del destinatario.
        city2:
          type: string
          description: >-
            Frazione del destinatario. Potrebbe essere utile se il chiamante non fornisce il cap.
        pr:
          type: string
          description: >-
            Provincia del destinatario; in caso di invio estero diventa facoltativo.
        country:
          type: string
          description: >-
            In caso di destinatario estero, diventa obbligatoria l’indicazione della nazione di destinazione, 
            in standard UPU o altro standard condiviso.