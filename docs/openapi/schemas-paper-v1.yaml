components:
  schemas:

    ##########################################################################
    ###                    RICHIESTA DI POSTALIZZAZIONE                    ###
    ##########################################################################

    ### - RICHIESTA
    ##################

    SendResponse:
      type: object
      required:
        - cost
        - receiverAddress
      properties:
        cost:
          description: ammontare in eurocent del costo per l'invio della notifica in forma cartacea
          type: number
        receiverAddress:
          description: indirizzo al quale verrà spedita la notifica
          type: object
          schema:
            $ref: '#/components/schemas/AnalogAddress'

    PrepareRequest:
      required:
        - requestId
        - requestPaId
        - clientRequestTimeStamp
        - productType
        - attachmentUrl
        - printType
        - senderAddress
      type: object
      properties:
        requestId:
          type: string
          example: 'ABCD-HILM-YKWX-202202-1_rec0_try1'
          description: >-
            Identificativo della richiesta.
        requestPaId:
          type: string
          example: '00414580183'
          description: >-
            Identificativo della PA che ha richiesto il recapito. Utile per autorizzare il
            recupero, da parte delle pubbliche amministrazioni, degli originali cartacei
        clientRequestTimeStamp:
          type: string
          format: date-time
          description: >-
            Timestamp della richiesta in UTC
        productType:
          description: >-
            Tipo prodotto di cui viene chiesto il recapito: <br/>
            - __AR__: Raccomandata Andata e Ritorno, <br/>
            - __890__: Recapito a norma della legge 890/1982, <br/>
            - __RI__: Raccomandata Internazionale, <br/>
            - __RS__: Raccomandata Semplice (per Avviso di mancato Recapito). <br/>
            - ... ulteriori prodotti 
          type: string
          example: 'AR'
        attachmentUrls:
          type: array
          items:
            type: string
            description: >-
              Path in cui si trova il documento da allegare alla comunicazione digitale
              (i.e. url del file dentro Safe Storage che si occuperà di crypt/decrypt dei documenti).
              Il Safe Storge si occuperà di calcolare la presigned url per il recupero dell'allegato che sarà decifrato.
              documentUrl può rispondere (alla GET) con un 403 per redirect vs servizio (i.e. lambda, safe storage, presigned url vs bucket s3 non cifrato).
        printType:
          type: string
          description: >-
            Indica il tipo di stampa richiesto al Consolidatore <br />
            - __BN_FRONTE__: bianco e nero solo fronte <br/>
            - __BN_FRONTE_RETRO__: bianco e nero fronte e retro <br/>
            - ... ulteriori modalità previste dal contratto
          example: 'BN_FRONTE_RETRO'
        receiverAddress:
          type: object
          schema:
            $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Estremi del destinatario
        receiverFiscalCode:
          type: string
          description: >-
            Serve per poter recuperare da ANPR l'eventuale indirizzo fornito dall'utente alla banca dati nazionale.
            Potrebbe inoltre servire ai recapitisti in caso di offerte migliorative per i destinatari (servizi a valore aggiunto basati su cf).
        senderAddress:
          type: object
          schema:
            $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Estremi della PA mittente
        senderDigitalAddress:  #// FIXME SE non serve togliere
          type: string
          description: >-
            Indirizzo PEC del mittente.
        arAddress:
          type: object
          schema:
            $ref: '#/components/schemas/AnalogAddress'
          description: >-
            Estremi della PA mittente per l'avviso di ritorno

    ##########################################################################
    ###      NOTIFICHE DI AVANZAMENTO DEL PROCESSO DI POSTALIZZAZIONE      ###
    ##########################################################################

    ### - EVENTO SINGOLO
    #####################

    PaperEvent:
      required:
        - requestId
        - statusCode
        - statusDetail
        - statusDateTime
      type: object
      properties:
        requestId:
          type: string
          description: >-
            Identificativo della richiesta.
          example: 'ABCD-HILM-YKWX-202202-1_rec0_try1'
        statusCode:
          type: string
          description: codice dell'evento.
        statusDetail:
          type: string
          description: dettaglio associato all'evento.
        statusDateTime:
          type: string
          format: date-time
          description: >-
              Data stato con timezone
        engageId:
          type: string
          description: eventuale nuovo engageId da usare in risposta

    PrepareEvent:
      allOf:
        - $ref: '#/components/schemas/PaperEvent'
      type: object
      properties:
        statusCode:
          type: string
          description: >-
            Codici ritornati:
            - PROGRESS :  stato iniziale che indica che la richiesta è in fase di elaborazione
            - OK : nel caso di indirizzo valido e allegati recuperati correttamente. Prevede la presenza dell'engageId
            - KO_UNREACHABLE : nel caso in cui non sia disponibile un indirizzo per l'utente
        engageId:
          type: string
          description: l'engageId da usare per richiedere l'invio di questa richiesta

    SendEvent:
      allOf:
        - $ref: '#/components/schemas/PaperEvent'
      type: object
      properties:
        registeredLetterCode:
          type: string
          description: >-
            Il codice di tracciatura obbligatorio per i prodotti di corrispondenza tracciata.
          example: '123456789abc'
        engageId:
          type: string
          description: eventuale nuovo engageId da usare per richiedere l'invio del secondo tentativo. >-
              paper-channel dovrà memorizzarsi l'indirizzo risolto a valle del KO di invio del primo tentativo.
              Delivery-push a questo punto richiederà eventualmente il send per il secondo tentativo.
              // FIXME Capire se va bene che paper-channel debba tenere in memoria queste informazioni (sensibili) e se si per quanto
              // valutare eventualmente dialogo con data-vault
        statusCode:
          type: string
          description: >-
            Vengono ribattuti gli esiti di ext-channel, più eventuali eventi interni a paper-channel (codici PCXXX)
            _Codifica sintetica dello stato dell'esito._  <br/>
            - __001__ Stampato  <br/>
            - __002__ Disponibile al recapitista  <br/>
            - __003__ Preso in carico dal recapitista  <br/>
            - __004__ Consegnata  <br/>
            - __005__ Mancata consegna  <br/>
            - __006__ Furto/Smarrimanto/deterioramento  <br/>
            - __007__ Consegnato Ufficio Postale  <br/>
            - __008__ Mancata consegna Ufficio Postale  <br/>
            - __009__ Compiuta giacenza  <br/>

            - __PC001__ Paper channel nuova richiesta invio cartaceo, a valle di un fallimento "temporaneo"  <br/>

        statusDescription: 
          type: string
          example: 'Stampato'
          description: >-
            Descrizione dello stato del delivery cartaceo che viene notificato.
        statusDateTime:
          type: string
          format: date-time
          description: >-
            Data stato con timezone
        deliveryFailureCause: 
          description: >-
            _Motivazione di mancata consegna_ obbligtorie negli stati di mancata consegna  <br/>
            - __01__ destinatario irreperibile <br/>
            - __02__ destinatario deceduto <br/>
            - __03__ destinatario sconosciuto <br/>
            - __04__ destinatario trasferito <br/>
            - __05__ invio rifiutato <br/>
            - __06__ indirizzo inesatto <br/>
            - __07__ indirizzo inesistente <br/>
            - __08__ indirizzo insufficiente <br/>
            - ... Motivazioni aggiuntive concordate con il consolidatore
          type: string
        attachments: 
          description: >-
            elenco dei documenti prodotti che attestano quanto accaduto durante il processo 
            di postalizzazione
          type: array
          items:
            $ref: '#/components/schemas/AttachmentDetails'
        discoveredAddress:
            $ref: '#/components/schemas/AnalogAddress'
        clientRequestTimeStamp:
          type: string
          format: date-time
          description: >-
            Timestamp della richiesta in UTC

    
    AttachmentDetails:
      title: dettagli allegato a un evento del processo postale
      type: object
      required: 
        - id
        - documentType
        - url
        - date
      properties:
        id: 
          type: string
          description: >-
            Identificativo di riga.
        documentType:
          type: string
          description: >-
            La descrizione della tipologia di oggetto.
        url:
          type: string
          description: >-
            Le coordinate del documento correlato allo stato. 
        date:
          type: string
          format: date-time
          description: >-
            Data di produzione del documento.

    AnalogAddress:
      description: >-
        Indirizzo analogico
      required:
        - name
        - address
        - city
      properties:
        name:
          type: string
          description: >-
            Cognome e nome o ragione sociale del destinatario
        nameRow2:
          type: string
          description: >-
            Seconda riga sulla busta.
        address:
          type: string
          description: >-
            Indirizzo del destinatario.
        addressRow2:
          type: string
          description: >-
            Specifica dell’indirizzo di residenza del destinatario (seconda riga indirizzo sulla busta).
        cap:
          type: string
          description: >-
            Cap del destinatario; in caso di invio estero diventa facoltativo.
        city:
          type: string
          description: >-
            Comune del destinatario.
        city2:
          type: string
          description: >-
            Frazione del destinatario. Potrebbe essere utile se il chiamante non fornisce il cap.
        pr:
          type: string
          description: >-
            Provincia del destinatario; in caso di invio estero diventa facoltativo.
        country:
          type: string
          description: >-
            In caso di destinatario estero, diventa obbligatoria l’indicazione della nazione di destinazione, 
            in standard UPU o altro standard condiviso.